From 4b14accd3829784b59f4c24b6f358f9fd816f0b2 Mon Sep 17 00:00:00 2001
From: Pierre-Hugues Husson <phh@phh.me>
Date: Tue, 30 May 2023 17:34:03 -0400
Subject: [PATCH 6/7] Add a property to cap declared le vendor version. Found
 needed on unisoc

---
 system/gd/hci/controller.cc | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/system/gd/hci/controller.cc b/system/gd/hci/controller.cc
index 56c6ae59de..e846b1ea0c 100644
--- a/system/gd/hci/controller.cc
+++ b/system/gd/hci/controller.cc
@@ -653,6 +653,13 @@ struct Controller::impl {
     }
     vendor_capabilities_.is_supported_ = 0x01;
 
+      int vendor_cap_max = 0xffff;
+      std::string vendor_cap_max_prop = GetSystemProperty("persist.sys.bt.max_vendor_cap").value_or("");
+      if (vendor_cap_max_prop != "") {
+          vendor_cap_max = std::stoi(vendor_cap_max_prop);
+      }
+      if (vendor_cap_max < 55) return;
+
     // v0.55
     BaseVendorCapabilities base_vendor_capabilities = complete_view.GetBaseVendorCapabilities();
     vendor_capabilities_.max_advt_instances_ = base_vendor_capabilities.max_advt_instances_;
@@ -672,6 +679,8 @@ struct Controller::impl {
       return;
     }
 
+    if (vendor_cap_max < 95) return;
+
     // v0.95
     auto v95 = LeGetVendorCapabilitiesComplete095View::Create(complete_view);
     if (!v95.IsValid()) {
@@ -688,6 +697,7 @@ struct Controller::impl {
       return;
     }
 
+    if (vendor_cap_max < 98) return;
     // v0.96
     auto v96 = LeGetVendorCapabilitiesComplete096View::Create(v95);
     if (!v96.IsValid()) {
-- 
2.34.1

